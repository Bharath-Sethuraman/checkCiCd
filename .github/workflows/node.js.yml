name: Auto Create and Merge PR to Main

on:
  push:
    branches:
      - '**'  # Trigger for all branches

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-create-and-merge-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Check if the branch is `main`
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "Running on main, skipping PR creation."
            exit 0
          fi

      - name: Create Pull Request to Main
        id: create-pr
        run: |
          PR_URL=$(gh pr create --base main --head "${GITHUB_REF#refs/heads/}" --title "Auto PR from ${GITHUB_REF#refs/heads/}" --body "This is an automated PR." --json url -q ".url")
          echo "PR created: $PR_URL"

      - name: Merge PR
        run: |
          echo "Merging PR ${{ steps.create-pr.outputs.PR_URL }} into main..."
          gh pr merge "${{ steps.create-pr.outputs.PR_URL }}" --merge --auto
