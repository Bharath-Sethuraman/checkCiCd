name: Auto Merge PRs to Main

on:
  push:
    branches:
      - '**'  # Triggers on push to any branch

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-pr-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Get open PRs targeting main
        id: list-prs
        run: |
          PR_LIST=$(gh pr list --state open --base main --json number,mergeable)
          echo "pr_data=$PR_LIST" >> $GITHUB_OUTPUT

      - name: Debug PR Data
        run: |
          echo "PR List: ${{ steps.list-prs.outputs.pr_data }}"

      - name: Enable Auto-Merge for PRs
        if: ${{ steps.list-prs.outputs.pr_data != '[]' }}
        run: |
          echo "${{ steps.list-prs.outputs.pr_data }}" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            mergeable=$(echo "$pr" | jq -r '.mergeable')
            if [ "$mergeable" == "MERGEABLE" ]; then
              echo "Enabling Auto-Merge for PR #$pr_number..."
              gh pr merge "$pr_number" --auto --merge
            else
              echo "PR #$pr_number is not mergeable (status: $mergeable). Skipping..."
            fi
          done

      - name: Merge PRs
        if: ${{ steps.list-prs.outputs.pr_data != '[]' }}
        run: |
          echo "${{ steps.list-prs.outputs.pr_data }}" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            mergeable=$(echo "$pr" | jq -r '.mergeable')
            if [ "$mergeable" == "MERGEABLE" ]; then
              echo "Merging PR #$pr_number into main..."
              gh pr merge "$pr_number" --merge
            else
              echo "PR #$pr_number is not mergeable (status: $mergeable). Skipping..."
            fi
          done
